<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FujiSim Pro</title>
    <style>
        body { margin: 0; background: #000; font-family: -apple-system, system-ui; color: white; overflow: hidden; }
        #container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        canvas { width: 100%; height: 75vh; object-fit: contain; }
        video { display: none; }
        
        .controls { height: 25vh; display: flex; flex-direction: column; align-items: center; justify-content: space-around; background: #111; padding: 10px; }
        .mode-selector { display: flex; gap: 10px; }
        button { 
            background: #333; border: none; color: #888; padding: 10px 15px; border-radius: 4px; font-size: 11px; font-weight: bold;
        }
        button.active { background: #e2b13c; color: #000; } /* Fuji Gold accent */
        
        .shutter-btn {
            width: 65px; height: 65px; border-radius: 50%; background: #fff; border: 4px solid #444;
        }

        /* Preview Overlay for Saving */
        #previewOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        #previewImg { max-width: 90%; max-height: 70%; border: 2px solid white; margin-bottom: 20px; }
        .close-btn { background: #cc0000; color: white; padding: 10px 20px; }
    </style>
</head>
<body>

<div id="container">
    <canvas id="glCanvas"></canvas>
    <video id="video" autoplay playsinline></video>

    <div class="controls">
        <div class="mode-selector">
            <button onclick="setMode('normal')" id="btn-normal" class="active">PROVIA (STD)</button>
            <button onclick="setMode('chrome')" id="btn-chrome">CLASSIC CHROME</button>
        </div>
        <button class="shutter-btn" onclick="takePhoto()"></button>
        <div style="font-size: 10px; color: #444;">ENGINE V2.0 | HI-RES JPEG</div>
    </div>
</div>

<div id="previewOverlay">
    <p>Photo Captured!</p>
    <img id="previewImg" src="" alt="Capture Preview">
    <p style="font-size: 14px;">Long-press image to "Save to Photos"</p>
    <button class="close-btn" onclick="closePreview()">BACK TO CAMERA</button>
</div>

<script>
    const canvas = document.getElementById('glCanvas');
    const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true }); // Crucial for saving
    const video = document.getElementById('video');
    const previewOverlay = document.getElementById('previewOverlay');
    const previewImg = document.getElementById('previewImg');
    let currentMode = 'normal';

    const vsSource = `attribute vec2 a_position; attribute vec2 a_texCoord; varying vec2 v_texCoord; void main() { gl_Position = vec4(a_position, 0, 1); v_texCoord = a_texCoord; }`;
    const fsSource = `
        precision mediump float;
        varying vec2 v_texCoord;
        uniform sampler2D u_image;
        uniform int u_mode;

        vec3 applyClassicChrome(vec3 color) {
            float luminance = dot(color, vec3(0.299, 0.587, 0.114));
            color = mix(vec3(luminance), color, 0.65); // Muted
            color = smoothstep(0.0, 1.0, color * 1.15 - 0.08); // Hard Contrast
            if(color.b > 0.4) { color.g += 0.04; color.r -= 0.02; } // Teal Shift
            return color;
        }

        void main() {
            vec4 tex = texture2D(u_image, v_texCoord);
            vec3 color = tex.rgb;
            if (u_mode == 1) color = applyClassicChrome(color);
            gl_FragColor = vec4(color, 1.0);
        }
    `;

    function initWebGL() {
        const program = createProgram(gl, vsSource, fsSource);
        const positionLoc = gl.getAttribLocation(program, "a_position");
        const texCoordLoc = gl.getAttribLocation(program, "a_texCoord");
        const modeLoc = gl.getUniformLocation(program, "u_mode");

        const posBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1]), gl.STATIC_DRAW);
        gl.enableVertexAttribArray(positionLoc);
        gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);

        const texBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, texBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0]), gl.STATIC_DRAW);
        gl.enableVertexAttribArray(texCoordLoc);
        gl.vertexAttribPointer(texCoordLoc, 2, gl.FLOAT, false, 0, 0);

        const texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);

        function render() {
            // FORCE HIGH RESOLUTION
            if (video.videoWidth > 0) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.useProgram(program);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, video);
            gl.uniform1i(modeLoc, currentMode === 'chrome' ? 1 : 0);
            gl.drawArrays(gl.TRIANGLES, 0, 6);
            requestAnimationFrame(render);
        }
        render();
    }

    function createProgram(gl, vs, fs) {
        const vS = gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vS, vs); gl.compileShader(vS);
        const fS = gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fS, fs); gl.compileShader(fS);
        const prog = gl.createProgram(); gl.attachShader(prog, vS); gl.attachShader(prog, fS);
        gl.linkProgram(prog); return prog;
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-selector button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');
    }

    function takePhoto() {
        // Capture at 0.95 Quality JPEG
        const dataUrl = canvas.toDataURL("image/jpeg", 0.95);
        previewImg.src = dataUrl;
        previewOverlay.style.display = 'flex';
    }

    function closePreview() {
        previewOverlay.style.display = 'none';
    }

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 4096 }, height: { ideal: 2160 } }, audio: false })
        .then(stream => { video.srcObject = stream; video.play(); initWebGL(); })
        .catch(err => alert("Camera Error: " + err));
</script>
</body>
</html>
